# 3.4、源码组织

### 目录结构

*下面的描述使用变量名$ CATALINA_BASE来引用可解决大多数相对路径的基本目录。如果尚未通过设置CATALINA_BASE目录为多个实例配置Tomcat，则$ CATALINA_BASE将设置为$ CATALINA_HOME的值，该目录已将Tomcat安装到该目录中。*

本手册的主要建议是将包含源代码（在本节中描述）的目录层次结构与包含可部署应用程序（在上一节中描述）的目录层次结构分开。保持这种分离具有以下优点：

- 如果未混合应用程序的“可执行”版本，则可以更轻松地管理，移动和备份源目录的内容。
- 在仅包含源文件的目录上，源代码控制更易于管理。
- 当部署层次结构分开时，组成应用程序可安装发行版的文件更容易选择。

就像我们将看到的那样，`ant`开发工具使创建和处理这样的目录层次结构几乎不费劲。

用来包含应用程序源代码的实际目录和文件层次结构几乎可以满足您的所有需求。但是，以下组织已被证明非常普遍适用，并且`build.xml`在下面讨论的示例配置文件中是预期的。所有这些组件都位于应用程序的顶级 *项目源目录*下：

- **docs /** -开发团队使用的任何格式的应用程序文档。

  

- **src /** -生成servlet，bean和其他Java类的Java源文件，这些servlet，bean和其他Java类对于您的应用程序是唯一的。如果您的源代码是按程序包组织的（**强烈** 建议），则程序包层次结构应反映为该目录下的目录结构。

  

- **web /** -应用程序客户端可以访问的网站的静态内容（HTML页面，JSP页面，JavaScript文件，CSS样式表文件和图像）。该目录将是Web应用程序的 *文档根目录*，在此找到的任何子目录结构都将反映在访问这些文件所需的请求URI中。

  

- **web / WEB-INF /** -应用程序所需的特殊配置文件，包括Web应用程序部署描述符（`web.xml`在[Servlet规范中](https://wiki.apache.org/tomcat/Specifications)定义 ），已创建的自定义标记库的标记库描述符以及希望包含的其他资源文件在您的Web应用程序中。即使此目录似乎是*文档根*目录的子目录，Servlet规范禁止将该目录（或其包含的任何文件）的内容直接提供给客户请求。因此，这是存储敏感配置信息（例如数据库连接用户名和密码）的好地方，但是配置信息是应用程序成功运行所必需的。

在开发过程中，将临时创建两个其他目录：

- **build /** -执行默认build（`ant`）时，此目录将包含此应用程序的Web应用程序存档中文件的确切映像。Tomcat允许您通过将应用程序复制到该`$CATALINA_BASE/webapps`目录或 通过“ Manager” Web应用程序进行*安装*，将其部署在这样的解压缩目录中 。后一种方法在开发过程中非常有用，下面将进行说明。

  

- **dist /** -执行`ant dist` 目标时，将创建此目录。它将为您的Web应用程序创建二进制分发的精确映像，包括您准备的许可证信息，文档和自述文件。

请注意，这两个目录应该**不要**在你的源代码控制系统的开发过程中需要存档，因为它们删除并重新创建（从零开始）。因此，如果要保留更改的永久记录，则不应编辑这些目录中的任何源文件，因为更改将在下次执行构建时丢失。

#### 外部依赖

如果您的应用程序需要外部项目或程序包中的JAR文件（或其他资源），该怎么办？一个常见的示例是您需要在Web应用程序中包括JDBC驱动程序才能进行操作。

不同的开发人员针对此问题采用不同的方法。有些人会鼓励为每个需要那些JAR文件的应用程序将您依赖的JAR文件的副本检查到源代码控制档案中。但是，当您在许多应用程序中使用相同的JAR时，这可能会导致重大的管理问题，尤其是当需要升级到该JAR文件的不同版本时。

因此，本手册建议您**不要**在应用程序的源代码管理档案中存储您依赖的软件包的副本。相反，应将外部依赖项集成为**构建**应用程序的过程的一部分。这样，您始终可以从开发系统管理员安装过的任何位置获取相应版本的JAR文件，而不必担心每次更改依赖JAR文件的版本时都会更新您的应用程序。

在示例Ant `build.xml`文件中，我们将演示如何定义*构建属性*，这些*属性*使您可以配置要复制的文件的位置，而不必`build.xml` 在这些文件更改时进行修改。特定开发人员使用的构建属性可以基于每个应用程序进行自定义，或者默认为存储在开发人员主目录中的“标准”构建属性。

在许多情况下，您的开发系统管理员已经将所需的JAR文件安装到`lib`Tomcat目录中。如果完成了此操作，则您根本不需要执行任何操作-示例`build.xml`文件会自动构造一个包含这些文件的编译类路径。

### 源代码控制

如前所述，强烈建议您将构成应用程序的所有源文件置于诸如并行版本系统（CVS）之类的源代码控制系统的管理之下。如果您选择这样做，在源层次结构的每个目录和文件应进行登记，并保存 - 但没有生成的文件。如果注册二进制格式的文件（例如图像或JAR库），请确保在源代码控制系统中指出这一点。

我们建议（在上一节中）不应将开发过程创建的`build/`和`dist/`目录的内容存储在源代码控制系统中。告诉CVS忽略这些目录的一种简单方法是`.cvsignore`在顶级源目录中创建一个名为 （请注意前导时期）的文件，其内容如下：

```bash
build
dist
build.properties
```

`build.properties`此处提及的原因将在“ [流程”](http://tomcat.apache.org/tomcat-9.0-doc/appdev/processes.html)部分中进行说明。

有关源代码控制环境的详细说明超出了本手册的范围。但是，使用命令行CVS客户端时，请遵循以下步骤：

- 要将源代码的状态刷新为源存储库中存储的状态，请转至项目的源目录，然后执行`cvs update -dP`。

  

- 当您在源代码层次结构中创建新的子目录时，请使用像这样的命令在CVS中注册它`cvs add {subdirname}`。

  

- 首次创建新的源代码文件时，请导航至包含该源代码的目录，然后使用诸如这样的命令注册新文件 `cvs add {filename}`。

  

- 如果您不再需要特定的源代码文件，请导航到包含的目录并删除该文件。然后，使用像这样的命令在CVS中注销它`cvs remove {filename}`。

  

- 在创建，修改和删除源文件时，更改尚未反映在服务器存储库中。要将更改保存为当前状态，请转到项目源目录并执行`cvs commit`。您将被要求写下您刚刚完成的更改的简短描述，并将其与任何更新的源文件的新版本一起存储。

像其他源代码控制系统一样，CVS具有许多其他功能（例如，标记组成特定发行版的文件的功能，以及对以后可以合并的多个开发分支的支持）。有关更多信息，请参见“ [简介”中](http://tomcat.apache.org/tomcat-9.0-doc/appdev/introduction.html)的链接和参考。

### BUILD.XML配置文件

我们将使用**ant**工具来管理Java源代码文件的编译以及部署层次结构的创建。Ant在通常称为的构建文件的控制下运行，该文件 `build.xml`定义了所需的处理步骤。此文件存储在源代码层次结构的顶级目录中，并且应签入源代码控制系统。

像Makefile一样，该`build.xml`文件提供了多个“目标”，这些目标支持可选的开发活动（例如，创建关联的Javadoc文档，擦除部署主目录，以便您可以从头开始构建项目，或者创建Web应用程序归档文件，以便进行分发您的应用程序。一个结构良好的`build.xml`文件将包含内部文档，这些文档描述了供开发人员使用的目标以及内部使用的目标。要让 Ant显示项目文档，请转到包含该`build.xml`文件的目录并键入：

```
ant -projecthelp
```

为了让您有一个良好的开端，提供了一个[基本的build.xml文件](http://tomcat.apache.org/tomcat-9.0-doc/appdev/build.xml.txt) ，您可以自定义该[文件](http://tomcat.apache.org/tomcat-9.0-doc/appdev/build.xml.txt)并将其安装在应用程序的项目源目录中。该文件包含描述可以执行的各种目标的注释。简要地说，通常提供以下目标：

- **clean-**此目标删除所有现有 目录`build`和`dist`目录，以便可以从头开始重建它们。这样可以保证您没有进行源代码修改，而由于没有重新编译所有受影响的类，这些修改将在运行时导致问题。

  

- **编译** -此目标用于编译自上次编译以来已更改的任何源代码。生成的类文件将在目录的`WEB-INF/classes` 子目录中创建，这`build`正是Web应用程序结构要求的位置。由于此命令在开发过程中经常执行，因此通常将其作为“默认”目标，这样一个简单的`ant`命令即可执行它。

  

- **全部** -此目标是运行`clean`目标的快捷方式 ，其次是`compile`目标。因此，它保证您将重新编译整个应用程序，以确保您在不知不觉中引入了任何不兼容的更改。

  

- **javadoc-**此目标为该Web应用程序中的Java类创建Javadoc API文档。该示例 `build.xml`文件假设您希望在应用程序发行版中包含API文档，因此它将在`dist`目录的子目录中生成文档。因为通常不需要在每次编译时都生成Javadocs，所以此目标通常是目标的依赖性`dist`，而不是目标 的依赖性`compile`。

  

- **dist-**此目标为您的应用程序创建分发目录，包括所有必需的文档，Java类的Javadocs以及Web应用程序归档（WAR）文件，这些文件将交付给希望安装您的应用程序的系统管理员。由于此目标也取决于`deploy`目标，因此Web应用程序归档文件还将选择部署时包含的所有外部依赖项。

为了使用Tomcat交互式开发和测试Web应用程序，定义了以下附加目标：

- **安装** -告诉当前正在运行的Tomcat使正在开发的应用程序立即可用于执行和测试。此操作不需要重新启动Tomcat，但在下次重新启动Tomcat之后也不会记住该操作。

  

- **重新加载** -安装应用程序后，您可以继续进行更改并使用`compile` 目标重新编译。Tomcat将自动识别对JSP页面所做的更改，而不是对Servlet或JavaBean类所做的更改-此命令将告诉Tomcat重新启动当前安装的应用程序，以便识别此类更改。

  

- **remove-**完成开发和测试活动后，可以选择告诉Tomcat从服务中删除该应用程序。

使用开发和测试目标需要一些额外的一次性设置，这将在下一页中进行介绍。
# 9.维护客户状态

许多应用需要从客户端的一系列请求彼此关联。例如，Web应用程序可以跨请求保存用户购物车的状态。基于Web的应用程序负责维护这种状态（称为会话），因为HTTP是无状态的。为了支持需要维护状态的应用程序，Java Servlet技术提供了用于管理会话的API，并允许使用多种机制来实现会话。



### 访问会话

会话由一个`HttpSession`对象表示。您可以通过调用`getSession`请求对象的方法来访问会话。此方法返回与此请求关联的当前会话。或者，如果请求中没有会话，则此方法将创建一个。



### 将对象与会话关联

您可以按名称将对象值属性与会话关联。属于同一Web上下文并且正在处理属于同一会话一部分的请求的任何Web组件均可访问此类属性。

回想一下，您的应用程序可以将servlet生命周期事件（[处理Servlet生命周期事件](https://javaee.github.io/tutorial/servlets002.html#BNAFJ)）通知Web上下文和会话侦听器对象。您还可以将与事件与会话的关联相关的某些事件通知对象，例如以下事件。

- 将对象添加到会话中或从会话中删除时。要接收此通知，您的对象必须实现该 `javax.servlet.http.HttpSessionBindingListener`接口。
- 附加对象的会话将被钝化或激活。当会话在虚拟机之间移动或保存到持久性存储中或从中恢复时，该会话将被钝化或激活。要接收此通知，您的对象必须实现该 `javax.servlet.http.HttpSessionActivationListener`接口。



### 会话管理

由于HTTP客户端无法发出不再需要会话的信号，因此每个会话都有关联的超时，因此可以回收其资源。可以使用会话`getMaxInactiveInterval`和`setMaxInactiveInterval`方法访问超时时间。

- 为确保活动会话不会超时，您应该使用服务方法定期访问该会话，因为这会重置会话的生存时间计数器。
- 当特定的客户端交互完成时，您可以使用会话的`invalidate`方法来使服务器端的会话无效并删除所有会话数据。



#### 使用NetBeans IDE设置超时期限

要使用NetBeans IDE在部署描述符中设置超时时间，请遵循以下步骤。

1. 如果尚未打开该项目。

2. 在“项目”选项卡中展开项目的节点。

3. 展开项目节点下的网页和WEB-INF节点。

4. 双击`web.xml`。

5. 单击编辑器顶部的“常规”。

6. 在会话超时字段中，输入一个整数值。

   整数值表示会话超时之前必须经过的无活动分钟数。



### 会话跟踪

为了将会话与用户关联，Web容器可以使用几种方法，所有这些方法都涉及在客户端和服务器之间传递标识符。标识符可以作为cookie保留在客户端上，或者Web组件可以在返回给客户端的每个URL中包含标识符。

如果您的应用程序使用会话对象，则必须在客户端关闭cookie时让应用程序重写URL，以确保启用了会话跟踪。您可以`encodeURL(URL)`通过对Servlet返回的所有URL 调用响应的方法来做到这一点 。仅当禁用cookie时，此方法才将会话ID包含在URL中；否则，该方法将返回不变的URL。
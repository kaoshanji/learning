#   Netty

Netty 是一个使用Java实现的高性能网络应用框架，应用非常普遍，目前基本上是网络程序的标配。

定义：提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序

##  背景

-   应用领域

网络编程应用框架

-   现在互联网场景

需要服务器能够支撑十万甚至百万连接，创建对应数量的线程是不现实。

连接多，但是每个连接上的请求并不频繁，线程大部分时间都在等待 I/O 就绪。

-   I/O、并发模型

对于网络请求一般可以分为两个处理阶段，一是接收请求任务，二是处理网络请求

I/O 模型决定连接请求接收发送，并发模型决定数据处理过程

-   socket 处理网络机制

socket 处理 TCP 网络连接请求，是在一个独立的 socket 中，每当有一个 TCP 连接成功建立，都会创建一个新的 socket，之后对 TCP 连接的读写都是由新创建处理的 socket 完成。

处理 TCP 连接请求和读写请求是通过两个不同的 socket 完成的。

----

##  主要问题

Java 网络编程应用框架，线程模型直接影响网络程序的性能。

Java 语言提供了三种I/O模型，但是这比较基础，不是直接面向应用开发。

在实际中直接使用Java语言的I/O类库，难度比较大，涉及的专业知识多，Bug概率较高，需要开发人员对这方面有很深的经验。

直接使用I/O模型，还需要其他功能支持，比如：编解码、线程安全、多种协议、多种模式切换等，才足以满足应用。

这由专门的类库解决，然后提供简单易用的API就好。

----

##  解决方案

-   线程模型

用一个线程来处理多个连接，线程利用率提高，所需的线程数量降低，这就是NIO。

具体实现是 Reactor 模式。

-   支持多种应用网络协议

FTP、SMTP、HTTP等各种二进制文本协议

-   支持多种传输网络协议

TCP、UDP、本地

-   设计
    -   针对多种传输类型的统一接口 - 阻塞和非阻塞
    -   简单但更强大的线程模型
    -   真正的无连接的数据报套接字支持
    -   链接逻辑支持复用

----


##  设计实现

### 特点

-   易用性
    -   大量的 Javadoc 和 代码`实例`
    -   除了在 JDK 1.6 + 额外的限制
-   性能
    -   比核心 Java API 更好的吞吐量，较低的延时
    -   资源消耗更少，这个得益于共享池和重用
    -   减少内存拷贝
-   健壮性
    -   消除由于慢，快，或重载连接产生的 OutOfMemoryError
    -   消除经常发现在 NIO 在高速网络中的应用中的不公平的读/写比
-   安全
    -   完整的 SSL / TLS 和 StartTLS 的支持
    -   运行在受限的环境例如 Applet 或 OSGI
-   社区
    -   发布的更早和更频繁
    -   社区驱动

### 功能

-   特性
    -   处理大容量数据流更简单
    -   处理协议编码和单元测试更简单
    -   I/O超时和idle状态检测
    -   应用程序的关闭更简单，更安全
    -   更可靠的OutOfMemoryError预防
-   传输方式
    -   基于BIO和NIO的UDP传输
    -   本地传输(又名 in-VM传输)
    -   HTTP通道，可绕过防火墙
-   编码器
    -   HTTP客户端和服务器端
    -   用于实现各种专有协议的工具
-   其他技术整合
    -   Google Protocol Buffers
    -   JBoss Microcontainer, OSGi, Guice以及Spring

### 要素

Netty 中最核心的概念是`事件循环`(EventLoop)，Reactor 模式中的 Reactor，负责监听网络事件并调用事件处理器进行处理。

在 4.x 版本的 Netty 中，网络连接 和 EventLoop 是稳定的多对一关系，而 EventLoop 和 Java线程 是 1 对 1 关系，稳定值得是关系一旦确定就不再发生变化。

一个网络连接只会对应唯一的一个 EventLoop，而一个 EventLoop 也只会对应到一个 Java 线程，所以，一个网络连接只会对应到一个 Java线程，这样对于一个网络连接的事件处理是单线程，就避免了各种并发问题。

由多个 EventLoop 组成了 EventLoopGroup ，实际应用中，一般会创建两个 EventLoopGroup，一个是 bossGroup ，一个称为 workerGroup ，这个与 socket 处理网络机制有关。

bossGroup 用来处理连接请求， workerGroup 用来处理读写请求。

bossGroup 处理完连接请求后，会将这个连接提交给 workerGroup 来处理， workerGroup 里面有多个 EventLoop ，使用负载均衡算法决定由那个 EventLoop 处理。

----


##  应用模式


----

##  典型案例
-   [grpc](https://grpc.io/)
-   [Dubbo](http://dubbo.apache.org/zh-cn/index.html)

----
